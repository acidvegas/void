#!/bin/sh
# git remote setup script - developed by acidvegas (https://git.acid.vegas)
#
# note: This assumes the directory structure of $HOME/dev/git/$USER/$REPO for each repository.
#
# usage:
#	gitremote    | Update current working directory repository
#	gitremote -a | Update every repository

SIGNING_KEY=$(gpg --list-keys --with-colons acidvegas | awk -F: '$1=="fpr"{print $10; exit}')

update_repo() {
	DIR=$1
	USER=$(basename $(dirname $(dirname $DIR)))
	REPO=$(basename $(dirname $DIR))
	
	echo "updating $USER/$REPO..."
	
	# Set GitHub org name (internet-relay-chat has hyphens on GitHub only)
	GH_USER=$([ "$USER" = "internetrelaychat" ] && echo "internet-relay-chat" || echo "$USER")
	
	# Remove and re-add remotes
	git -C $DIR remote remove origin
	git -C $DIR remote add origin ssh://git@github.com/$GH_USER/$REPO.git
	for REMOTE in github.com gitlab.com codeberg.org git.supernets.org:31337; do
		git -C $DIR remote set-url --add --push origin ssh://git@$REMOTE/$USER/$REPO.git
	done
	git -C $DIR config user.signingkey $SIGNING_KEY
	
	# Handle repository description
	DESC_FILE=$DIR/description
	if [ ! -f "$DESC_FILE" ] || grep -q "Unnamed repository" "$DESC_FILE"; then
		echo "Enter a description for $REPO:"
		read DESC
		echo "$DESC" > "$DESC_FILE"
	fi
}

[ -d $PWD/.git ] && update_repo $PWD/.git || echo "invalid repository: missing .git directory"
