#!/bin/bash
# ubuntu setup script - developed by acidvegas (https://git.acid.vegas/void)

# note: After importing keys: printf "FINGERPRINTHERE:6:" | gpg --import-ownertrust

# Set xtrace, exit on error, & verbose mode
set -xev

# Configuration
GIT_URL="https://raw.githubusercontent.com/acidvegas/void/master"
GPG_ID=$(gpg --list-keys --with-colons acidvegas | awk -F: '$1=="fpr"{print $10; exit}')
HOSTNAME="deathstar"


setup_packages() {
	# Install GUI dependant packages
	sudo apt install -y firefox nemo redshift rpi-imager steam-installer virtualbox vlc xclip
	sudo apt install -y fonts-noto-core fonts-noto-extra fonts-noto-cjk fonts-noto-color-emoji fonts-dejavu fonts-freefont-ttf
	sudo apt install -y eyed3 rhythmbox
	sudo apt install -y gnome-tweaks gnome-shell-extensions gnome-shell-extension-manager

	# Install development packages
	sudo apt install -y ansible python3 python3-pip

	# Install essential packages
	sudo apt install -y ca-certificates curl delta eza fzf git grc jq ncdu nvme-cli oathtool progress rsync smartmontools tmux tree unzip whois zip

	# Install font packages
	sudo apt install -y fontforge python3-fontforge

	# Install networking packages
	sudo apt install -y tor wireguard wireguard-tools

	# Install reconnaissance packages
	sudo apt install -y gpsd marble masscan mitmproxy netcat-openbsd nmap strace tcpdump termshark tshark wireshark

	# Install snap packages
	sudo snap install drawio ghidra zulip

	# Setup Antigravity
	curl -fsSL https://us-central1-apt.pkg.dev/doc/repo-signing-key.gpg | sudo gpg --dearmor --yes -o /etc/apt/keyrings/antigravity-repo-key.gpg
	echo "deb [signed-by=/etc/apt/keyrings/antigravity-repo-key.gpg] https://us-central1-apt.pkg.dev/projects/antigravity-auto-updater-dev/ antigravity-debian main" | sudo tee /etc/apt/sources.list.d/antigravity.list > /dev/null

	# Install Docker
	curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
	echo "deb [signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu noble stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null

	# Install Mullvad VPN
	curl -fsSL https://repository.mullvad.net/deb/mullvad-keyring.asc | sudo gpg --dearmor -o /etc/apt/keyrings/mullvad-archive-keyring.gpg
	echo "deb [signed-by=/etc/apt/keyrings/mullvad-archive-keyring.gpg] https://repository.mullvad.net/deb stable main" | sudo tee /etc/apt/sources.list.d/mullvad.list >/dev/null

	# Install Obsidian
	curl -sS https://apt.obsidian.md/obsidian.asc | sudo gpg --dearmor -o /etc/apt/keyrings/obsidian.gpg
	echo "deb [signed-by=/etc/apt/keyrings/obsidian.gpg] https://apt.obsidian.md stable main" | sudo tee /etc/apt/sources.list.d/obsidian.list

	# Install Signal
	curl -fsSL https://updates.signal.org/desktop/apt/keys.asc | sudo gpg --dearmor -o /etc/apt/keyrings/signal-desktop-keyring.gpg
	echo "deb [signed-by=/etc/apt/keyrings/signal-desktop-keyring.gpg] https://updates.signal.org/desktop/apt xenial main" | sudo tee /etc/apt/sources.list.d/signal-desktop.list >/dev/null

	# Install Spotify
	curl -fsSL https://download.spotify.com/debian/pubkey_C85668DF69375001.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/spotify-archive-keyring.gpg
	echo "deb [signed-by=/etc/apt/keyrings/spotify-archive-keyring.gpg] http://repository.spotify.com stable non-free" | sudo tee /etc/apt/sources.list.d/spotify.list >/dev/null

	# Install Tailscale
	curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /etc/apt/keyrings/tailscale-archive-keyring.gpg >/dev/null
	echo "deb [signed-by=/etc/apt/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null

	# Install packages
	sudo apt update && sudo apt install -y docker-ce containerd.io mullvad-vpn signal-desktop spotify-client tailscale

	# Add user to docker group
	sudo gpasswd -a $USER docker

	# Install Github builds
	git clone --depth 1 https://github.com/AngelJumbo/lavat.git /tmp/lavat && sudo make -C /tmp/lavat clean install && rm -rf /tmp/lavat
	git clone --depth 1 https://github.com/lptstr/fire.git      /tmp/fire  && sudo make -C /tmp/fire  clean install && rm -rf /tmp/fire
	git clone --depth 1 https://github.com/ricoriedel/wipe      /tmp/wipe  && sudo cargo build --release --manifest-path /tmp/wipe/Cargo.toml && rm -rf /tmp/wipe
}


setup_root() {
	# Setup hostname
	hostnamectl set-hostname $HOSTNAME

	# Setup Bash
	printf "[[ \$- != *i* ]] && return\nshopt -s checkwinsize\nexport EDITOR=nano\nexport VISUAL=nano\nexport HISTCONTROL=ignoredups\nexport HISTFILE=/dev/null\nexport HISTFILESIZE=0\nexport HISTSIZE=100\nexport LESSHISTFILE=/dev/null\nexport PYTHONHISTFILE=/dev/null" > /etc/bash.bashrc

	# Setup Nano
	printf "set boldtext\nset minibar\nset nohelp\nset nowrap\nset quickblank\nset tabsize 4\nunbind ^J main\nunbind ^L main\nset selectedcolor black,red\ninclude \"/usr/share/nano/*.nanorc\"\n" | sudo tee /etc/nanorc > /dev/null

	# Setup Sudoers
	printf "Defaults lecture = always\nDefaults lecture_file = /etc/sudoers.d/sudoers.lecture\nroot ALL=(ALL) ALL\n%%sudo ALL=(ALL) ALL\n" | sudo tee /etc/sudoers > /dev/null
	printf "\n\033[1m     \033[32m\"Bee\" careful    \033[34m__\n       \033[32mwith sudo!    \033[34m// \ \n                     \\\\\\_/ \033[33m//\n   \033[35m''-.._.-''-.._.. \033[33m-(||)(')\n                     '''\033[0m\n" | sudo tee /etc/sudoers.d/sudoers.lecture > /dev/null

	# Enable GRC
	sudo sed -i 's/GRC_ALIASES=false/GRC_ALIASES=true/' /etc/default/grc
}


setup_user() {
	# Setup Bash
	mkdir -p $HOME/.local/share/bash
	for item in bash_aliases bash_functions bash_fun bash_recon; do
		wget -O $HOME/.local/share/bash/$item $GIT_URL/local/share/bash/$item
	done
	wget -O $HOME/.bashrc $GIT_URL/.bashrc
	sed -i '/HISTCONTROL/d' $HOME/.bashrc

	# Setup Git
	mkdir -p $HOME/.config/git && wget -O $HOME/.config/git/config $GIT_URL/config/git/config
	sed -i "s|CHANGEME|$GPG_ID|" $HOME/.config/git/config

	# Setup GPG
	mkdir -p $HOME/.local/share/gnupg
	echo "default-key $GPG_ID" > $HOME/.local/share/gnupg/gpg.conf
	printf "pinentry-program /usr/bin/pinentry-curses\ndefault-cache-ttl 3600" > $HOME/.local/share/gnupg/gpg-agent.conf
	chmod 700 $HOME/.local/share/gnupg && chmod 600 $HOME/.local/share/gnupg/*

	# Setup Claude
	curl -fsSL https://claude.ai/install.sh | bash

	# Setup Cursor
	wget -O $HOME/.local/bin/cursor https://downloader.cursor.sh/linux/appImage/x64
	chmod u+x $HOME/.local/bin/cursor

	# Setup Codex
	wget -O /tmp/codex-x86_64-unknown-linux-musl.tar.gz https://github.com/openai/codex/releases/latest/download/codex-x86_64-unknown-linux-musl.tar.gz
	tar -xf /tmp/codex-x86_64-unknown-linux-musl.tar.gz
	mv /tmp/codex-x86_64-unknown-linux-musl/codex $HOME/.local/bin/codex
	chmod u+x $HOME/.local/bin/codex
	rm -rf /tmp/codex-x86_64-unknown-linux-musl*

	# Setup Pip
	mkdir -p $HOME/.config/pip && printf "[global]\nbreak-system-packages = true" > ~/.config/pip/pip.conf
	python3 -m pip install --user aiodns aiofiles aioftp aiohttp aiokafka aiormq aiosocks apv beautifulsoup4 cryptography dnspython elasticsearch flask gitpython meshtastic python-dotenv python-socks scapy tqdm websockets zulip-term
	
	# Setup Scripts
	mkdir -p $HOME/.local/bin/scripts
	for SCRIPT in gitremote irc-post-commit-hook mutag; do
		wget -O $HOME/.local/bin/scripts/$SCRIPT $GIT_URL/scripts/$SCRIPT
	done

	# Setup Redshift
	(crontab -l 2>/dev/null; echo "0 23 * * * DISPLAY=:0 redshift -P -O 4000"; echo "0 7 * * * DISPLAY=:0 redshift -x") | crontab -

	# Download fonts
	mkdir -p $HOME/.local/share/fonts
	wget -O $HOME/.local/share/fonts/BlockZone.ttf $GIT_URL/local/share/fonts/BlockZone.ttf
	fc-cache -fv

	# Patch BlockZone with Nerd Font icons
	git clone --depth 1 https://github.com/ryanoasis/nerd-fonts.git /tmp/nerd-fonts
	cd /tmp/nerd-fonts && python3 font-patcher ~/.local/share/fonts/BlockZone.ttf --complete --makegroups 0 --out ~/.local/share/fonts
	fc-cache -fv
	rm -rf /tmp/nerd-fonts

	# Set terminal font
	TERMINAL_PROFILE=$(gsettings get org.gnome.Terminal.ProfilesList default | tr -d "'")
	gsettings set org.gnome.Terminal.Legacy.Profile:/org/gnome/terminal/legacy/profiles:/:$TERMINAL_PROFILE/ font 'BlockZone Nerd Font 12'
	gsettings set org.gnome.Terminal.Legacy.Profile:/org/gnome/terminal/legacy/profiles:/:$TERMINAL_PROFILE/ use-system-font false
	
	# Set terminal colors
	dconf write /org/gnome/terminal/legacy/profiles:/:$TERMINAL_PROFILE/use-theme-colors false
	dconf write /org/gnome/terminal/legacy/profiles:/:$TERMINAL_PROFILE/foreground-color "'#f8f8f2'"
	dconf write /org/gnome/terminal/legacy/profiles:/:$TERMINAL_PROFILE/background-color "'#000000'"
	dconf write /org/gnome/terminal/legacy/profiles:/:$TERMINAL_PROFILE/palette "['#21222c','#ff5555','#50fa7b','#f1fa8c','#bd93f9','#ff79c6','#8be9fd','#f8f8f2','#6272a4','#ff6e6e','#69ff94','#ffffa5','#d6acff','#ff92df','#a4ffff','#ffffff']"

	# Setup Tmux
	mkdir -p $HOME/.config/tmux && wget -O $HOME/.config/tmux/tmux.conf $GIT_URL/config/tmux/tmux.conf
	wget -O $HOME/.local/bin/tmux-session-menu $GIT_URL/local/bin/tmux-session-menu && chmod u+x $HOME/.local/bin/tmux-session-menu

	# Setup Nemo & remove nautilus defaults
	xdg-mime default nemo.desktop inode/directory application/x-gnome-saved-search
	gsettings set org.gnome.desktop.background show-desktop-icons false
	gsettings set org.gnome.nautilus.desktop home-icon-visible    false
	gsettings set org.gnome.nautilus.desktop trash-icon-visible   false
	gsettings set org.gnome.nautilus.desktop volumes-visible      false

	# Setup Dracula GTK theme
	echo "Download GTK theme from https://www.gnome-look.org/p/1687249 and extract to ~/.themes or /usr/share/themes"
	echo "gsettings set org.gnome.desktop.interface gtk-theme Dracula"
	echo "gsettings set org.gnome.desktop.wm.preferences theme Dracula"
	echo "this may require logging out and back in, idk how to automate this"
}

[ $# -eq 0         ] && echo "Usage: setup <packages|root|user>" && exit 1
[ $1 != "packages" ] && [ $1 != "root" ] && [ $1 != "user" ] && echo "Invalid argument: $1" && exit 1

setup_$1